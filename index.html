<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Superendividamento</title>
  
  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Recharts CDN -->
  <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
  
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    const Icon = ({ name, size = 24, className = "", color }) => {
      const ref = React.useRef(null);
      
      React.useEffect(() => {
        if (ref.current && window.lucide) {
          const iconElement = window.lucide.createElement(window.lucide[name]);
          if (iconElement) {
            ref.current.innerHTML = '';
            ref.current.appendChild(iconElement);
          }
        }
      }, [name]);
      
      return <i ref={ref} className={className} style={{ width: size, height: size, display: 'inline-block', color }}></i>;
    };

    const DebtDashboard = () => {
      const [currentView, setCurrentView] = useState('list');
      const [clients, setClients] = useState([]);
      const [selectedClient, setSelectedClient] = useState(null);
      const [loading, setLoading] = useState(true);

      const [clientName, setClientName] = useState('');
      const [clientCPF, setClientCPF] = useState('');
      const [salary, setSalary] = useState('');
      const [debts, setDebts] = useState({
        creditCard: '',
        personalLoans: '',
        overdraft: '',
        installments: '',
        utilities: '',
        vehicleFinancing: '',
        services: ''
      });

      const debtCategories = [
        { key: 'creditCard', label: 'Cart√£o de Cr√©dito', icon: 'üí≥', color: '#ef4444' },
        { key: 'personalLoans', label: 'Empr√©stimos Pessoais', icon: 'üí∞', color: '#f97316' },
        { key: 'overdraft', label: 'Cheque Especial/CDC', icon: 'üè¶', color: '#f59e0b' },
        { key: 'installments', label: 'Credi√°rio', icon: 'üõí', color: '#eab308' },
        { key: 'utilities', label: 'Contas Essenciais', icon: 'üì±', color: '#84cc16' },
        { key: 'vehicleFinancing', label: 'Financiamento Ve√≠culos', icon: 'üöó', color: '#06b6d4' },
        { key: 'services', label: 'Servi√ßos Cont√≠nuos', icon: 'üìÜ', color: '#8b5cf6' }
      ];

      useEffect(() => {
        loadClients();
      }, []);

      const loadClients = async () => {
        try {
          setLoading(true);
          const result = await window.storage.list('client:');
          if (result && result.keys) {
            const clientsData = await Promise.all(
              result.keys.map(async (key) => {
                try {
                  const data = await window.storage.get(key);
                  return data ? JSON.parse(data.value) : null;
                } catch (e) {
                  return null;
                }
              })
            );
            setClients(clientsData.filter(c => c !== null));
          }
        } catch (error) {
          console.log('Nenhum cliente cadastrado ainda');
          setClients([]);
        } finally {
          setLoading(false);
        }
      };

      const handleDebtChange = (key, value) => {
        setDebts(prev => ({ ...prev, [key]: value }));
      };

      const saveClient = async () => {
        if (!clientName.trim() || !clientCPF.trim()) {
          alert('Por favor, preencha o nome e CPF do cliente');
          return;
        }

        const clientData = {
          id: selectedClient?.id || `client:${Date.now()}`,
          name: clientName,
          cpf: clientCPF,
          salary: parseFloat(salary) || 0,
          debts: {
            creditCard: parseFloat(debts.creditCard) || 0,
            personalLoans: parseFloat(debts.personalLoans) || 0,
            overdraft: parseFloat(debts.overdraft) || 0,
            installments: parseFloat(debts.installments) || 0,
            utilities: parseFloat(debts.utilities) || 0,
            vehicleFinancing: parseFloat(debts.vehicleFinancing) || 0,
            services: parseFloat(debts.services) || 0
          },
          updatedAt: new Date().toISOString()
        };

        try {
          await window.storage.set(clientData.id, JSON.stringify(clientData));
          alert('Cliente salvo com sucesso!');
          await loadClients();
          setCurrentView('list');
          resetForm();
        } catch (error) {
          alert('Erro ao salvar cliente: ' + error.message);
        }
      };

      const deleteClient = async (clientId) => {
        if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

        try {
          await window.storage.delete(clientId);
          await loadClients();
          alert('Cliente exclu√≠do com sucesso!');
        } catch (error) {
          alert('Erro ao excluir cliente: ' + error.message);
        }
      };

      const editClient = (client) => {
        setSelectedClient(client);
        setClientName(client.name);
        setClientCPF(client.cpf);
        setSalary(client.salary.toString());
        setDebts({
          creditCard: client.debts.creditCard.toString(),
          personalLoans: client.debts.personalLoans.toString(),
          overdraft: client.debts.overdraft.toString(),
          installments: client.debts.installments.toString(),
          utilities: client.debts.utilities.toString(),
          vehicleFinancing: client.debts.vehicleFinancing.toString(),
          services: client.debts.services.toString()
        });
        setCurrentView('edit');
      };

      const resetForm = () => {
        setClientName('');
        setClientCPF('');
        setSalary('');
        setDebts({
          creditCard: '',
          personalLoans: '',
          overdraft: '',
          installments: '',
          utilities: '',
          vehicleFinancing: '',
          services: ''
        });
        setSelectedClient(null);
      };

      const calculations = useMemo(() => {
        const salaryNum = parseFloat(salary) || 0;
        const debtValues = Object.values(debts).map(v => parseFloat(v) || 0);
        const totalDebts = debtValues.reduce((sum, val) => sum + val, 0);
        const commitmentRatio = salaryNum > 0 ? (totalDebts / salaryNum) * 100 : 0;
        const remainingIncome = salaryNum - totalDebts;
        
        let status = 'saud√°vel';
        let statusColor = '#10b981';
        let statusMessage = 'Situa√ß√£o financeira controlada';
        
        if (commitmentRatio > 100) {
          status = 'cr√≠tico';
          statusColor = '#ef4444';
          statusMessage = 'Superendividamento cr√≠tico - d√≠vidas excedem a renda';
        } else if (commitmentRatio > 70) {
          status = 'grave';
          statusColor = '#f97316';
          statusMessage = 'Situa√ß√£o grave - alto comprometimento de renda';
        } else if (commitmentRatio > 50) {
          status = 'alerta';
          statusColor = '#eab308';
          statusMessage = 'Aten√ß√£o - comprometimento elevado';
        } else if (commitmentRatio > 30) {
          status = 'moderado';
          statusColor = '#3b82f6';
          statusMessage = 'Comprometimento moderado';
        }

        return {
          salaryNum,
          totalDebts,
          commitmentRatio,
          remainingIncome,
          status,
          statusColor,
          statusMessage
        };
      }, [salary, debts]);

      const pieChartData = useMemo(() => {
        const data = debtCategories
          .map(cat => ({
            name: cat.label,
            value: parseFloat(debts[cat.key]) || 0,
            color: cat.color
          }))
          .filter(item => item.value > 0);
        
        return data;
      }, [debts]);

      const comparisonData = [
        { name: 'Sal√°rio', value: calculations.salaryNum, fill: '#10b981' },
        { name: 'D√≠vidas', value: calculations.totalDebts, fill: '#ef4444' }
      ];

      const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(value || 0);
      };

      const formatCPF = (cpf) => {
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      };

      if (currentView === 'list') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
            <div className="max-w-7xl mx-auto">
              <div className="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h1 className="text-4xl font-bold text-slate-800 mb-2">
                      Gest√£o de Clientes
                    </h1>
                    <p className="text-slate-600">Controle de superendividamento por cliente</p>
                  </div>
                  <button
                    onClick={() => {
                      resetForm();
                      setCurrentView('new');
                    }}
                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold transition-colors"
                  >
                    <Icon name="UserPlus" size={20} />
                    Novo Cliente
                  </button>
                </div>
              </div>

              {loading ? (
                <div className="text-center py-12">
                  <div className="text-slate-600">Carregando clientes...</div>
                </div>
              ) : clients.length === 0 ? (
                <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
                  <Icon name="Users" size={64} className="mx-auto text-slate-300 mb-4" />
                  <h2 className="text-2xl font-bold text-slate-800 mb-2">
                    Nenhum cliente cadastrado
                  </h2>
                  <p className="text-slate-600 mb-6">
                    Comece adicionando seu primeiro cliente
                  </p>
                  <button
                    onClick={() => {
                      resetForm();
                      setCurrentView('new');
                    }}
                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold transition-colors mx-auto"
                  >
                    <Icon name="UserPlus" size={20} />
                    Adicionar Cliente
                  </button>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {clients.map(client => {
                    const totalDebts = Object.values(client.debts).reduce((sum, val) => sum + val, 0);
                    const commitmentRatio = client.salary > 0 ? (totalDebts / client.salary) * 100 : 0;
                    
                    let statusColor = '#10b981';
                    if (commitmentRatio > 100) statusColor = '#ef4444';
                    else if (commitmentRatio > 70) statusColor = '#f97316';
                    else if (commitmentRatio > 50) statusColor = '#eab308';
                    else if (commitmentRatio > 30) statusColor = '#3b82f6';

                    return (
                      <div key={client.id} className="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex-1">
                            <h3 className="text-xl font-bold text-slate-800 mb-1">
                              {client.name}
                            </h3>
                            <p className="text-sm text-slate-600">
                              CPF: {formatCPF(client.cpf)}
                            </p>
                          </div>
                          <div 
                            className="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold"
                            style={{ backgroundColor: statusColor }}
                          >
                            {commitmentRatio.toFixed(0)}%
                          </div>
                        </div>

                        <div className="space-y-2 mb-4">
                          <div className="flex justify-between text-sm">
                            <span className="text-slate-600">Sal√°rio:</span>
                            <span className="font-semibold">{formatCurrency(client.salary)}</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-slate-600">D√≠vidas:</span>
                            <span className="font-semibold text-red-600">{formatCurrency(totalDebts)}</span>
                          </div>
                        </div>

                        <div className="w-full bg-slate-200 rounded-full h-2 mb-4">
                          <div
                            className="h-2 rounded-full transition-all"
                            style={{ 
                              width: `${Math.min(commitmentRatio, 100)}%`,
                              backgroundColor: statusColor
                            }}
                          />
                        </div>

                        <div className="flex gap-2">
                          <button
                            onClick={() => editClient(client)}
                            className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                          >
                            Visualizar
                          </button>
                          <button
                            onClick={() => deleteClient(client.id)}
                            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
                          >
                            <Icon name="Trash2" size={18} />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6">
              <div className="flex items-center gap-4 mb-4">
                <button
                  onClick={() => {
                    setCurrentView('list');
                    resetForm();
                  }}
                  className="text-slate-600 hover:text-slate-800"
                >
                  <Icon name="ArrowLeft" size={24} />
                </button>
                <div>
                  <h1 className="text-4xl font-bold text-slate-800 mb-2">
                    {currentView === 'new' ? 'Novo Cliente' : 'Editar Cliente'}
                  </h1>
                  <p className="text-slate-600">
                    {currentView === 'new' ? 'Cadastre um novo cliente e suas informa√ß√µes financeiras' : 'Atualize as informa√ß√µes do cliente'}
                  </p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6">
              <h2 className="text-2xl font-bold text-slate-800 mb-6">Dados do Cliente</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-slate-700 mb-2">
                    Nome Completo *
                  </label>
                  <input
                    type="text"
                    value={clientName}
                    onChange={(e) => setClientName(e.target.value)}
                    placeholder="Jo√£o da Silva"
                    className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-slate-700 mb-2">
                    CPF *
                  </label>
                  <input
                    type="text"
                    value={clientCPF}
                    onChange={(e) => setClientCPF(e.target.value.replace(/\D/g, ''))}
                    placeholder="000.000.000-00"
                    maxLength="11"
                    className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none"
                  />
                </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6">
              <h2 className="text-2xl font-bold text-slate-800 mb-6">Informa√ß√µes Financeiras</h2>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-slate-700 mb-2">
                  üíµ Sal√°rio/Renda Mensal
                </label>
                <input
                  type="number"
                  value={salary}
                  onChange={(e) => setSalary(e.target.value)}
                  placeholder="R$ 0,00"
                  className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {debtCategories.map(cat => (
                  <div key={cat.key}>
                    <label className="block text-sm font-semibold text-slate-700 mb-2">
                      {cat.icon} {cat.label}
                    </label>
                    <input
                      type="number"
                      value={debts[cat.key]}
                      onChange={(e) => handleDebtChange(cat.key, e.target.value)}
                      placeholder="R$ 0,00"
                      className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none"
                    />
                  </div>
                ))}
              </div>
            </div>

            <div className="flex justify-end gap-4 mb-6">
              <button
                onClick={() => {
                  setCurrentView('list');
                  resetForm();
                }}
                className="px-6 py-3 border-2 border-slate-300 text-slate-700 rounded-xl font-semibold hover:bg-slate-50 transition-colors"
              >
                Cancelar
              </button>
              <button
                onClick={saveClient}
                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold transition-colors"
              >
                <Icon name="Save" size={20} />
                Salvar Cliente
              </button>
            </div>

            {calculations.salaryNum > 0 && (
              <>
                <div 
                  className="rounded-2xl shadow-lg p-6 mb-6 text-white"
                  style={{ backgroundColor: calculations.statusColor }}
                >
                  <div className="flex items-center gap-4">
                    <Icon name="AlertCircle" size={48} />
                    <div className="flex-1">
                      <h3 className="text-2xl font-bold mb-1">
                        Status: {calculations.status.toUpperCase()}
                      </h3>
                      <p className="text-lg opacity-90">{calculations.statusMessage}</p>
                    </div>
                    <div className="text-right">
                      <div className="text-3xl font-bold">
                        {calculations.commitmentRatio.toFixed(1)}%
                      </div>
                      <div className="text-sm opacity-90">da renda comprometida</div>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-slate-600 font-semibold">Total de D√≠vidas</span>
                      <Icon name="TrendingUp" size={24} color="#ef4444" />
                    </div>
                    <div className="text-3xl font-bold text-slate-800">
                      {formatCurrency(calculations.totalDebts)}
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-slate-600 font-semibold">Renda Restante</span>
                      <Icon name="DollarSign" size={24} color={calculations.remainingIncome >= 0 ? '#10b981' : '#ef4444'} />
                    </div>
                    <div className={`text-3xl font-bold ${calculations.remainingIncome >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {formatCurrency(calculations.remainingIncome)}
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-slate-600 font-semibold">Comprometimento</span>
                      <Icon name="TrendingDown" size={24} color="#3b82f6" />
                    </div>
                    <div className="text-3xl font-bold text-slate-800">
                      {calculations.commitmentRatio.toFixed(1)}%
                    </div>
                  </div>
                </div>

                {calculations.totalDebts > 0 && (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white rounded-2xl shadow-lg p-6">
                      <h3 className="text-xl font-bold text-slate-800 mb-4">
                        Distribui√ß√£o das D√≠vidas
                      </h3>
                      <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                          <Pie
                            data={pieChartData}
                            cx="50%"
                            cy="50%"
                            labelLine={false}
                            label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                            outerRadius={100}
                            fill="#8884d8"
                            dataKey="value"
                          >
                            {pieChartData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.color} />
                            ))}
                          </Pie>
                          <Tooltip formatter={(value) => formatCurrency(value)} />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-white rounded-2xl shadow-lg p-6">
                      <h3 className="text-xl font-bold text-slate-800 mb-4">
                        Sal√°rio vs D√≠vidas
                      </h3>
                      <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={comparisonData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip formatter={(value) => formatCurrency(value)} />
                          <Bar dataKey="value" fill="#8884d8" radius={[8, 8, 0, 0]} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-white rounded-2xl shadow-lg p-6 lg:col-span-2">
                      <h3 className="text-xl font-bold text-slate-800 mb-4">
                        Detalhamento por Categoria
                      </h3>
                      <div className="space-y-3">
                        {debtCategories.map(cat => {
                          const value = parseFloat(debts[cat.key]) || 0;
                          const percentage = calculations.totalDebts > 0 ? (value / calculations.totalDebts) * 100 : 0;
                          
                          if (value === 0) return null;
                          
                          return (
                            <div key={cat.key} className="flex items-center gap-4">
                              <div className="text-2xl">{cat.icon}</div>
                              <div className="flex-1">
                                <div className="flex justify-between mb-1">
                                  <span className="font-semibold text-slate-700">{cat.label}</span>
                                  <span className="font-bold text-slate-800">{formatCurrency(value)}</span>
                                </div>
                                <div className="w-full bg-slate-200 rounded-full h-3">
                                  <div
                                    className="h-3 rounded-full transition-all duration-500"
                                    style={{ 
                                      width: `${percentage}%`,
                                      backgroundColor: cat.color
                                    }}
                                  />
                                </div>
                                <div className="text-sm text-slate-600 mt-1">
                                  {percentage.toFixed(1)}% do total de d√≠vidas
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </>
            )}

            <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mt-6">
              <h3 className="text-lg font-bold text-blue-900 mb-2">
                ‚öñÔ∏è Informa√ß√µes Legais - Lei do Superendividamento
              </h3>
              <p className="text-blue-800 text-sm">
                A Lei 14.181/2021 garante ao consumidor superendividado o direito de renegociar suas d√≠vidas. 
                Considera-se superendividado o consumidor que tem suas d√≠vidas comprometendo substancialmente 
                sua capacidade de subsist√™ncia digna. Este dashboard auxilia na identifica√ß√£o da situa√ß√£o 
                e pode servir como base para a√ß√µes de renegocia√ß√£o ou judicial.
              </p>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DebtDashboard />);
  </script>
</body>
</html>
